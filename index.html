<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Camera</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

.video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}
.hidden {
  visibility: hidden;
}
</style>
</head>

<body>

<video id="videoA" class="video" playsinline preload="auto"></video>
<video id="videoB" class="video hidden" playsinline preload="auto"></video>

<input
  id="uploader"
  type="file"
  accept="image/*"
  capture="user"
  hidden
/>

<script>
/* ─────────────────────────────
   CONFIG
───────────────────────────── */
const BASE =
  "https://pub-3c96f33aff6b452c83e88bfef455da73.r2.dev/";

const STEPS = [
  BASE + "camera_idle.mp4",
  BASE + "lens_cap_off.mp4",
  BASE + "film_crank.mp4",
  BASE + "photo_taken.mp4"
];

const UPLOAD_API =
  "https://archive-worker.coldbrainarchive.workers.dev/upload?purpose=camera";

/* ─────────────────────────────
   RETURN SCENE
───────────────────────────── */
const params = new URLSearchParams(location.search);
const sceneFromGame = params.get("scene");
if (sceneFromGame) {
  localStorage.setItem("returnScene", sceneFromGame);
}

function goBack(extra = {}) {
  const scene = localStorage.getItem("returnScene") || "";
  location.href =
    `https://coldbrainarchive.pages.dev/?scene=${scene}&` +
    new URLSearchParams(extra);
}

/* ─────────────────────────────
   VIDEO ENGINE (DOUBLE BUFFER)
───────────────────────────── */
const vids = [
  document.getElementById("videoA"),
  document.getElementById("videoB")
];
const uploader = document.getElementById("uploader");

let front = 0;
let back = 1;
let step = 0;
let locked = false;

function swap() {
  vids[front].classList.add("hidden");
  vids[back].classList.remove("hidden");
  [front, back] = [back, front];
}

function holdFirstFrame(src) {
  const v = vids[back];
  v.src = src;
  v.currentTime = 0;
  v.muted = false;
  v.onloadeddata = () => {
    v.pause();
    swap();
  };
  v.load();
}

function playAndHoldNext(src, onEnd) {
  const v = vids[back];
  v.src = src;
  v.currentTime = 0;
  v.muted = false;
  v.onloadeddata = () => {
    swap();
    v.play();
  };
  v.onended = () => {
    v.onended = null;
    if (onEnd) onEnd();
  };
  v.load();
}

/* ─────────────────────────────
   INIT
───────────────────────────── */
holdFirstFrame(STEPS[0]);

/* ─────────────────────────────
   TAP = ADVANCE
───────────────────────────── */
document.body.addEventListener("pointerdown", () => {
  if (locked) return;

  // Step 0 → 1
  if (step === 0) {
    locked = true;
    playAndHoldNext(STEPS[1], () => {
      step = 1;
      locked = false;
      holdFirstFrame(STEPS[1]);
    });
  }

  // Step 1 → 2 (camera opens immediately)
  else if (step === 1) {
    locked = true;
    uploader.value = "";
    uploader.click(); // MUST be inside gesture
    playAndHoldNext(STEPS[2], () => {
      step = 2;
      locked = false;
      holdFirstFrame(STEPS[2]);
    });
  }
});

/* ─────────────────────────────
   PHOTO RESULT
───────────────────────────── */
uploader.addEventListener("change", async () => {
  const file = uploader.files[0];

  if (!file) {
    // Cancel → stay usable
    locked = false;
    return;
  }

  try {
    const res = await fetch(UPLOAD_API, {
      method: "POST",
      headers: { "Content-Type": file.type || "image/jpeg" },
      body: file
    });

    const data = await res.json();

    locked = true;
    playAndHoldNext(STEPS[3], () => {
      goBack({
        verified: data.verified ? "true" : "false",
        image: data.publicUrl || ""
      });
    });

  } catch {
    goBack({ verified: "false" });
  }
});
</script>

</body>
</html>
