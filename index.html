<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Camera</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ─────────────────────────────
   CORE RING
───────────────────────────── */
#circle {
  position: relative;
  width: 160px;
  height: 160px;
  border-radius: 50%;
  border: 10px solid rgba(255,255,255,0.95);
  background: transparent;
  box-sizing: border-box;
  touch-action: manipulation;

  box-shadow:
    0 0 18px rgba(255,255,255,0.6),
    0 0 40px rgba(200,220,255,0.35),
    0 0 90px rgba(160,200,255,0.18);

  animation: breathe 3.2s ease-in-out infinite;
}

#circle::before {
  content: "";
  position: absolute;
  inset: -35px;
  border-radius: 50%;
  background: radial-gradient(
    circle,
    rgba(200,220,255,0.18),
    rgba(120,180,255,0.08),
    transparent 70%
  );
  filter: blur(18px);
  opacity: 0.85;
  animation: halo 3.2s ease-in-out infinite;
  pointer-events: none;
}

#circle::after {
  content: "";
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.65);
  filter: blur(1.5px);
  opacity: 0.9;
  pointer-events: none;
}

@keyframes breathe {
  0% {
    transform: scale(1);
    box-shadow:
      0 0 18px rgba(255,255,255,0.55),
      0 0 40px rgba(200,220,255,0.32),
      0 0 90px rgba(160,200,255,0.15);
  }
  50% {
    transform: scale(1.045);
    box-shadow:
      0 0 26px rgba(255,255,255,0.85),
      0 0 65px rgba(220,240,255,0.55),
      0 0 140px rgba(180,220,255,0.3);
  }
  100% {
    transform: scale(1);
    box-shadow:
      0 0 18px rgba(255,255,255,0.55),
      0 0 40px rgba(200,220,255,0.32),
      0 0 90px rgba(160,200,255,0.15);
  }
}

@keyframes halo {
  0%   { opacity: 0.6; }
  50%  { opacity: 1; }
  100% { opacity: 0.6; }
}

input {
  display: none;
}
</style>
</head>

<body>

<div id="circle"></div>

<input
  id="uploader"
  type="file"
  accept="video/*"
  capture="user"
/>

<script>
const UPLOAD_API =
  "https://archive-worker.coldbrainarchive.workers.dev/upload?purpose=camera";

/* ─────────────────────────────
   CAPTURE RETURN SCENE ON ENTRY
───────────────────────────── */
const params = new URLSearchParams(location.search);
const sceneFromGame = params.get("scene");

if (sceneFromGame) {
  localStorage.setItem("returnScene", sceneFromGame);
}

const circle = document.getElementById("circle");
const uploader = document.getElementById("uploader");

/* ─────────────────────────────
   RETURN HANDLING
───────────────────────────── */
function goBack(extra = {}) {
  const scene = localStorage.getItem("returnScene") || "";
  const qs = new URLSearchParams({
    ...(scene ? { scene } : {}),
    ...extra
  });

  location.href =
    `https://coldbrainarchive.pages.dev/?${qs.toString()}`;
}

/* ─────────────────────────────
   FRAME EXTRACTION (iOS SAFE)
───────────────────────────── */
async function extractFrameBase64(file) {
  return new Promise((resolve, reject) => {
    const video = document.createElement("video");
    const url = URL.createObjectURL(file);

    video.src = url;
    video.muted = true;
    video.playsInline = true;
    video.preload = "auto";

    video.onloadeddata = () => {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      URL.revokeObjectURL(url);

      const base64 = canvas
        .toDataURL("image/jpeg", 0.9)
        .split(",")[1];

      resolve(base64);
    };

    video.onerror = reject;
    video.load(); // REQUIRED on iOS
  });
}

/* ─────────────────────────────
   OPEN CAMERA
───────────────────────────── */
circle.addEventListener("click", () => {
  uploader.value = "";
  uploader.click();
});

/* ─────────────────────────────
   TAP OUTSIDE → CANCEL & RETURN
───────────────────────────── */
document.body.addEventListener("pointerdown", (e) => {
  if (!circle.contains(e.target)) {
    goBack({ verified: "false" });
  }
});

/* ─────────────────────────────
   HANDLE VIDEO
───────────────────────────── */
uploader.addEventListener("change", async () => {
  const file = uploader.files[0];
  if (!file) return;

  try {
    const imageBase64 = await extractFrameBase64(file);

    const res = await fetch(UPLOAD_API, {
      method: "POST",
      headers: {
        "Content-Type": file.type || "video/mp4"
      },
      body: file
    });

    if (!res.ok) throw new Error("Upload failed");

    const data = await res.json();

    const visionRes = await fetch(
      "https://script.google.com/macros/s/AKfycbyCRugnoCKl_T6EPuHs6D-ZUuT5LyMpp5Q7YC_d0W7q1jDzpG0dp94sQYQin7WwqT0N4g/exec",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          image: imageBase64,
          video: data.publicUrl
        })
      }
    );

    const visionData = await visionRes.json();
    const verified = visionData.verified === true;

    goBack({
      verified: verified ? "true" : "false",
      video: verified ? data.publicUrl : ""
    });

  } catch (err) {
    console.error(err);
    goBack({ verified: "false" });
  }
});
</script>
/* ─────────────────────────────
   OPEN CAMERA
───────────────────────────── */
circle.addEventListener("click", () => {
  uploader.value = "";
  uploader.click();
});

/* ─────────────────────────────
   TAP OUTSIDE → CANCEL & RETURN
───────────────────────────── */
document.body.addEventListener("pointerdown", (e) => {
  if (!circle.contains(e.target)) {
    goBack({ verified: "false" });
  }
});

/* ─────────────────────────────
   HANDLE VIDEO
───────────────────────────── */
uploader.addEventListener("change", async () => {
  const file = uploader.files[0];

  // User cancelled camera
  if (!file) return;

 try {
  // 1️⃣ Extract a face frame
  const imageBase64 = await extractFrameBase64(file);

  // 2️⃣ Upload video
  const res = await fetch(UPLOAD_API, {
    method: "POST",
    headers: {
      "Content-Type": file.type || "video/mp4"
    },
    body: file
  });

  if (!res.ok) throw new Error("Upload failed");

  const data = await res.json();

  // 3️⃣ Send image to Vision
  const visionRes = await fetch(
    "https://script.google.com/macros/s/AKfycbyCRugnoCKl_T6EPuHs6D-ZUuT5LyMpp5Q7YC_d0W7q1jDzpG0dp94sQYQin7WwqT0N4g/exec",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        image: imageBase64,
        video: data.publicUrl
      })
    }
  );

  const visionData = await visionRes.json();

  // 4️⃣ Decide verification
  const verified = visionData.verified === true;

  // 5️⃣ Return to game ONCE
  goBack({
    verified: verified ? "true" : "false",
    video: verified ? data.publicUrl : ""
  });

} catch (err) {
  console.error(err);
  goBack({ verified: "false" });
}
});
</script>

</body>
</html>
