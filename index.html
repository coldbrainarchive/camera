<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Camera</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}

.hidden { visibility: hidden; }

/* ðŸ”´ Camera interaction zone */
#cameraZone {
  position: fixed;
  left: 8%;
  top: 22%;
  width: 84%;
  height: 40%;
  z-index: 10;
}

/* ðŸŸ¢ Exit zone */
#exitZone {
  position: fixed;
  left: 8%;
  top: 68%;
  width: 84%;
  height: 24%;
  z-index: 11;
}

/* ðŸŸ¦ Fullscreen result tap */
#resultZone {
  position: fixed;
  inset: 0;
  z-index: 20;
  display: none;
}
</style>
</head>

<body>

<video id="v1" playsinline preload="auto"></video>
<video id="v2" playsinline preload="auto" class="hidden"></video>

<input
  id="uploader"
  type="file"
  accept="image/*"
  capture="user"
/>

<div id="cameraZone"></div>
<div id="exitZone"></div>
<div id="resultZone"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFIG
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const BASE = "https://pub-3c96f33aff6b452c83e88bfef455da73.r2.dev/";

const LENS    = BASE + "lens_cap_off.mp4";
const CRANK   = BASE + "film_crank.mp4";
const SNAP    = BASE + "photo_taken.mp4";
const WINDING = BASE + "winding.mp4";
const PASS    = BASE + "pass.mp4";
const FAIL    = BASE + "fail.mp4";

const UPLOAD_API =
  "https://archive-worker.coldbrainarchive.workers.dev/upload?purpose=camera";

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RETURN NODE (NEW + FIXED)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const params = new URLSearchParams(location.search);
const returnNode = params.get("return");

function goBack(extra = {}) {
  if (!returnNode) {
    // Safety fallback
    location.href = "https://coldbrainarchive.pages.dev/";
    return;
  }

  location.href =
    "https://coldbrainarchive.pages.dev/?" +
    new URLSearchParams({
      node: returnNode,
      ...extra
    });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   VIDEO ENGINE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const vids = [v1, v2];
const uploader = document.getElementById("uploader");
const cameraZone = document.getElementById("cameraZone");
const exitZone = document.getElementById("exitZone");
const resultZone = document.getElementById("resultZone");

let front = 0;
let back = 1;
let state = 0;
let busy = false;
let resultPayload = null;

/*
  STATES:
  0 = lens
  1 = crank
  2 = ready_for_camera
  3 = result_hold
*/

function swap() {
  vids[front].classList.add("hidden");
  vids[back].classList.remove("hidden");
  [front, back] = [back, front];
}

function stopAll() {
  vids.forEach(v => {
    v.pause();
    v.loop = false;
    v.currentTime = 0;
    v.onended = null;
  });
}

function holdFirstFrame(src) {
  const v = vids[back];
  v.src = src;
  v.currentTime = 0;
  v.pause();
  v.load();
  v.requestVideoFrameCallback(() => swap());
}

function playThenHold(src, next, cb) {
  busy = true;
  stopAll();

  const v = vids[back];
  v.src = src;
  v.load();

  v.requestVideoFrameCallback(() => {
    swap();
    v.play();
  });

  v.onended = () => {
    v.onended = null;
    if (next) holdFirstFrame(next);
    busy = false;
    cb && cb();
  };
}

function playWindingLoop() {
  busy = true;
  stopAll();

  const v = vids[back];
  v.src = WINDING;
  v.loop = true;
  v.load();

  v.requestVideoFrameCallback(() => {
    swap();
    v.play();
  });
}

function playThenHoldLast(src, payload) {
  stopAll();

  const v = vids[back];
  v.src = src;
  v.load();

  v.requestVideoFrameCallback(() => {
    swap();
    v.play();
  });

  v.onended = () => {
    v.pause();
    state = 3;
    resultPayload = payload;
    resultZone.style.display = "block";
    busy = false;
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
holdFirstFrame(LENS);

/* ðŸ”´ CAMERA ZONE */
cameraZone.addEventListener("click", () => {
  if (busy || state === 3) return;

  if (state === 0) playThenHold(LENS, CRANK, () => state = 1);
  else if (state === 1) playThenHold(CRANK, SNAP, () => state = 2);
  else if (state === 2) {
    uploader.value = "";
    uploader.click();
  }
});

/* ðŸŸ¢ EXIT â†’ FORCE FAIL */
exitZone.addEventListener("click", () => {
  if (busy || state === 3) return;
  playThenHoldLast(FAIL, { verified: "false" });
});

/* ðŸŸ¦ RESULT FULLSCREEN TAP */
resultZone.addEventListener("click", () => {
  if (resultPayload) goBack(resultPayload);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PHOTO FLOW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
uploader.addEventListener("change", async () => {
  const file = uploader.files[0];
  if (!file) return;

  playThenHold(SNAP, null, async () => {
    playWindingLoop();

    try {
      const res = await fetch(UPLOAD_API, {
        method: "POST",
        headers: { "Content-Type": file.type },
        body: file
      });

      const data = await res.json();
      playThenHoldLast(
        data.verified ? PASS : FAIL,
        {
          verified: data.verified ? "true" : "false",
          image: data.publicUrl
        }
      );

    } catch {
      playThenHoldLast(FAIL, { verified: "false" });
    }
  });
});
</script>

</body>
</html>
