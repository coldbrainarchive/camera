<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Camera</title>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: black;
  overflow: hidden;
}

#wrap {
  position: relative;
  width: 100%;
  height: 100%;
}

video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  background: black;
}

/* Invisible tap zones */
.tap {
  position: absolute;
  pointer-events: auto;
}

/* Lens area (center) */
#tap-lens {
  left: 30%;
  top: 35%;
  width: 40%;
  height: 35%;
}

/* Shutter button (top right) */
#tap-shutter {
  right: 8%;
  top: 8%;
  width: 18%;
  height: 18%;
}
</style>
</head>

<body>

<div id="wrap">
  <video
    id="camVideo"
    playsinline
    muted
    preload="auto"
  ></video>

  <div id="tap-lens" class="tap"></div>
  <div id="tap-shutter" class="tap"></div>
</div>

<input
  id="uploader"
  type="file"
  accept="image/*"
  capture="user"
  hidden
/>

<script>
/* ─────────────────────────────
   CONFIG
───────────────────────────── */
const VIDEO_BASE =
  "https://pub-3c96f33aff6b452c83e88bfef455da73.r2.dev/";

const VIDEOS = {
  idle:  VIDEO_BASE + "camera_idle.mp4",
  lens:  VIDEO_BASE + "lens_cap_off.mp4",
  crank: VIDEO_BASE + "film_crank.mp4",
  snap:  VIDEO_BASE + "photo_taken.mp4"
};

const UPLOAD_API =
  "https://archive-worker.coldbrainarchive.workers.dev/upload?purpose=camera";

/* ─────────────────────────────
   RETURN SCENE
───────────────────────────── */
const params = new URLSearchParams(location.search);
const sceneFromGame = params.get("scene");
if (sceneFromGame) {
  localStorage.setItem("returnScene", sceneFromGame);
}

function goBack(extra = {}) {
  const scene = localStorage.getItem("returnScene") || "";
  const qs = new URLSearchParams({
    ...(scene ? { scene } : {}),
    ...extra
  });
  location.href =
    `https://coldbrainarchive.pages.dev/?${qs.toString()}`;
}

/* ─────────────────────────────
   VIDEO ENGINE
───────────────────────────── */
const video = document.getElementById("camVideo");
const uploader = document.getElementById("uploader");

let state = 0;
// 0 = idle
// 1 = lens off
// 2 = waiting for photo
// 3 = snap → return

function showFirstFrame(src) {
  video.loop = false;
  video.src = src;
  video.currentTime = 0;
  video.load();
}

function playOnce(src, onEnd) {
  video.loop = false;
  video.src = src;
  video.currentTime = 0;
  video.play();

  video.onended = () => {
    video.onended = null;
    if (onEnd) onEnd();
  };
}

/* ─────────────────────────────
   INIT
───────────────────────────── */
showFirstFrame(VIDEOS.idle);

/* ─────────────────────────────
   LENS TAP
───────────────────────────── */
document.getElementById("tap-lens").addEventListener("click", () => {
  if (state !== 0) return;
  state = 1;

  playOnce(VIDEOS.lens, () => {
    showFirstFrame(VIDEOS.idle);
  });
});

/* ─────────────────────────────
   SHUTTER TAP (MOBILE SAFE)
───────────────────────────── */
document.getElementById("tap-shutter").addEventListener("click", () => {
  if (state !== 1) return;
  state = 2;

  // MUST be inside user gesture for iOS
  uploader.value = "";
  uploader.click();

  playOnce(VIDEOS.crank);
});

/* ─────────────────────────────
   PHOTO RESULT
───────────────────────────── */
uploader.addEventListener("change", async () => {
  const file = uploader.files[0];
  if (!file) {
    state = 0;
    showFirstFrame(VIDEOS.idle);
    return;
  }

  try {
    const res = await fetch(UPLOAD_API, {
      method: "POST",
      headers: { "Content-Type": file.type || "image/jpeg" },
      body: file
    });

    if (!res.ok) throw new Error();

    const data = await res.json();
    state = 3;

    playOnce(VIDEOS.snap, () => {
      goBack({
        verified: data.verified ? "true" : "false",
        image: data.verified ? data.publicUrl : ""
      });
    });

  } catch {
    goBack({ verified: "false" });
  }
});
</script>

</body>
</html>
